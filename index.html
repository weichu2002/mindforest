<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MindForest - æ€ç»´é“¾åŠ©æ‰‹</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.26.0/cytoscape.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.2/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/katex.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/katex.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/contrib/auto-render.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>

    <style>
        body, html { height: 100%; overflow: hidden; font-family: 'Segoe UI', system-ui, sans-serif; }
        
        /* æ»šåŠ¨æ¡æ ·å¼ */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }

        /* ç”»å¸ƒå®¹å™¨ */
        #cy {
            width: 100%; height: 100%;
            background-color: #f8fafc;
            background-image: radial-gradient(#cbd5e1 1px, transparent 1px);
            background-size: 20px 20px;
            position: absolute; top: 0; left: 0;
            touch-action: none; 
            z-index: 0; 
        }

        /* Markdown & LaTeX æ ·å¼å¢å¼º */
        .prose { font-size: 0.95rem; line-height: 1.7; }
        .prose p { margin-bottom: 0.8em; }
        .prose pre { background: #1e293b !important; color: #e2e8f0; padding: 1rem; border-radius: 0.5rem; overflow-x: auto; margin: 1em 0; }
        .prose code { background: #f1f5f9; padding: 0.2em 0.4em; border-radius: 0.25rem; color: #ef4444; font-size: 0.9em; font-family: monospace; }
        .prose pre code { background: transparent; color: inherit; padding: 0; }
        
        /* è¡¨æ ¼æ ·å¼ */
        .prose table { border-collapse: collapse; width: 100%; margin: 1em 0; font-size: 0.9em; }
        .prose th, .prose td { border: 1px solid #e2e8f0; padding: 8px; text-align: left; }
        .prose th { background-color: #f8fafc; font-weight: 600; }

        /* KaTeX æº¢å‡ºä¿®å¤ */
        .katex-display { overflow-x: auto; overflow-y: hidden; padding: 0.5em 0; -webkit-overflow-scrolling: touch; }
        
        /* åŠ¨ç”» */
        .typing-dot { animation: typing 1.4s infinite ease-in-out both; }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
        
        @keyframes slideUp { from { transform: translateY(10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .animate-slide-up { animation: slideUp 0.2s ease-out forwards; }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 flex" oncontextmenu="return false;"> 

    <aside class="w-64 bg-slate-900 text-white flex flex-col flex-shrink-0 z-40 shadow-xl relative" id="sidebar">
        <div class="p-4 border-b border-slate-700 flex justify-between items-center bg-slate-900">
            <h1 class="font-bold text-xl tracking-wider"><i class="fa-solid fa-tree mr-2 text-green-400"></i>MindForest</h1>
        </div>

        <div class="p-3">
            <button onclick="createNewChat()" class="w-full bg-blue-600 hover:bg-blue-500 text-white py-2 px-4 rounded-lg flex items-center justify-center gap-2 transition-colors shadow-lg text-sm font-medium mb-2">
                <i class="fa-solid fa-plus"></i> æ–°å»ºæ€ç»´é“¾
            </button>
        </div>

        <div class="flex-1 overflow-y-auto px-3 py-2 space-y-2" id="history-list"></div>

        <div class="p-4 border-t border-slate-700 text-[10px] text-slate-400 text-center select-none">
            Powered by DeepSeek AI
        </div>
    </aside>

    <main class="flex-1 flex flex-col relative h-full">
        <header class="h-14 bg-white border-b flex items-center justify-between px-6 shadow-sm z-30 relative">
            <div class="flex items-center gap-4">
                <span id="current-chat-title" class="font-semibold text-gray-700">æœªå‘½åå¯¹è¯</span>
            </div>
            <div class="flex items-center gap-3">
                <button onclick="toggleView()" class="flex items-center gap-2 px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-md transition-colors font-medium text-sm border border-slate-300">
                    <i class="fa-solid fa-project-diagram"></i>
                    <span id="view-toggle-text">åˆ‡æ¢æ€ç»´æ ‘è§†å›¾</span>
                </button>
            </div>
        </header>

        <div class="flex-1 relative overflow-hidden">
            <div id="stream-view" class="absolute inset-0 flex flex-col bg-white z-10 transition-opacity duration-300">
                <div id="chat-container" class="flex-1 overflow-y-auto p-4 space-y-6 pb-48"></div>

                <div class="border-t bg-white p-4 absolute bottom-0 w-full z-20 shadow-[0_-4px_20px_rgba(0,0,0,0.05)]">
                    <div class="flex flex-wrap gap-2 mb-2 px-1">
                        <div id="branch-indicator" class="hidden text-xs text-blue-600 font-semibold flex items-center gap-2 bg-blue-50 p-1.5 rounded border border-blue-100 animate-slide-up">
                            <i class="fa-solid fa-code-branch"></i>
                            <span>æ­£åœ¨åŸºäºå†å²èŠ‚ç‚¹åˆ›å»ºæ–°åˆ†æ”¯...</span>
                            <button onclick="cancelBranching()" class="ml-2 hover:text-blue-800"><i class="fa-solid fa-times"></i></button>
                        </div>
                        <div id="file-preview" class="hidden flex items-center gap-2 bg-gray-100 p-1.5 rounded text-xs border border-gray-200 animate-slide-up">
                            <i class="fa-solid fa-file-word text-blue-600"></i>
                            <span id="file-name" class="font-mono text-gray-700 truncate max-w-[150px]">doc.docx</span>
                            <button onclick="clearFile()" class="ml-1 text-gray-500 hover:text-red-500"><i class="fa-solid fa-times"></i></button>
                        </div>
                    </div>

                    <div class="relative max-w-5xl mx-auto flex gap-3 items-end">
                        <div class="flex flex-col gap-2 pb-1">
                            <button onclick="toggleSystemPromptConfig()" class="p-2 text-gray-500 hover:bg-purple-100 hover:text-purple-600 rounded-full transition-colors relative" title="è®¾ç½® AI äººè®¾">
                                <i class="fa-solid fa-masks-theater"></i>
                            </button>
                            <button onclick="document.getElementById('file-upload').click()" class="p-2 text-gray-500 hover:bg-blue-100 hover:text-blue-600 rounded-full transition-colors" title="ä¸Šä¼  Word æ–‡æ¡£">
                                <i class="fa-solid fa-paperclip"></i>
                            </button>
                        </div>
                        <input type="file" id="file-upload" class="hidden" accept=".docx" onchange="handleFileUpload(this)">

                        <div class="flex-1 relative">
                            <textarea id="user-input" rows="1" class="w-full pl-4 pr-12 py-3 bg-gray-100 border-0 rounded-xl focus:ring-2 focus:ring-blue-500 focus:bg-white resize-none shadow-sm max-h-32 overflow-y-auto text-sm" placeholder="è¾“å…¥å†…å®¹... Enter å‘é€, Shift+Enter æ¢è¡Œ" oninput="this.style.height='';this.style.height=Math.min(this.scrollHeight, 128)+'px'"></textarea>
                            <button onclick="sendMessage()" class="absolute right-2 bottom-2 p-2 text-blue-600 hover:bg-blue-100 rounded-lg transition-colors">
                                <i class="fa-solid fa-paper-plane text-lg"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="tree-view" class="absolute inset-0 opacity-0 pointer-events-none transition-opacity duration-300 z-20 bg-slate-50">
                <div id="cy"></div>
                
                <div class="absolute bottom-6 left-6 bg-white/90 backdrop-blur p-4 rounded-lg shadow-xl border border-gray-200 text-sm max-w-xs z-30 select-none pointer-events-none">
                    <h3 class="font-bold mb-2 text-gray-800 flex items-center gap-2"><i class="fa-solid fa-sitemap text-blue-500"></i> æ“ä½œæŒ‡å—</h3>
                    <ul class="space-y-1 text-gray-600 text-xs pl-1">
                        <li><i class="fa-solid fa-arrow-pointer w-4"></i> <b>å·¦é”®ç‚¹å‡»</b>ï¼šè·³è½¬åˆ°è¯¥èŠ‚ç‚¹</li>
                        <li><i class="fa-regular fa-eye w-4"></i> <b>å³é”®ç‚¹å‡»</b>ï¼šæŸ¥çœ‹è¯¦ç»†å†…å®¹</li>
                        <li><i class="fa-solid fa-up-down-left-right w-4"></i> <b>æ»šè½®/æ‹–æ‹½</b>ï¼šå¹³ç§»ç¼©æ”¾</li>
                    </ul>
                </div>
            </div>
        </div>
    </main>

    <!-- ç³»ç»Ÿæç¤ºè¯æ¨¡æ€æ¡† -->
    <div id="system-prompt-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center">
        <div class="bg-white rounded-xl shadow-2xl w-96 p-6 animate-slide-up">
            <h3 class="text-lg font-bold mb-4 flex items-center gap-2"><i class="fa-solid fa-masks-theater text-purple-600"></i> è®¾ç½® AI äººè®¾</h3>
            <textarea id="system-prompt-input" class="w-full h-32 p-3 border rounded-lg bg-gray-50 focus:ring-2 focus:ring-purple-500 text-sm resize-none" placeholder="åœ¨æ­¤è¾“å…¥ System Prompt..."></textarea>
            <div class="flex justify-end gap-2 mt-4">
                <button onclick="toggleSystemPromptConfig()" class="px-4 py-2 text-gray-500 hover:bg-gray-100 rounded-lg text-sm">å–æ¶ˆ</button>
                <button onclick="saveSystemPrompt()" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg text-sm">ç¡®è®¤</button>
            </div>
        </div>
    </div>

    <!-- èŠ‚ç‚¹è¯¦æƒ…æ¨¡æ€æ¡† -->
    <div id="node-detail-modal" class="fixed inset-0 bg-black/40 z-50 hidden flex items-center justify-center backdrop-blur-sm" onclick="closeNodeDetail()">
        <div class="bg-white rounded-xl shadow-2xl w-[800px] max-w-[95%] max-h-[85vh] flex flex-col animate-slide-up" onclick="event.stopPropagation()">
            <div class="p-4 border-b flex justify-between items-center bg-gray-50 rounded-t-xl select-none">
                <div class="flex items-center gap-2">
                    <span id="detail-role-icon"></span>
                    <h3 class="font-bold text-gray-700">èŠ‚ç‚¹è¯¦æƒ…</h3>
                </div>
                <button onclick="closeNodeDetail()" class="text-gray-400 hover:text-gray-600 w-8 h-8 rounded-full hover:bg-gray-200 flex items-center justify-center"><i class="fa-solid fa-times"></i></button>
            </div>
            <div class="p-6 overflow-y-auto prose prose-sm max-w-none" id="node-detail-content"></div>
            <div class="p-4 border-t bg-gray-50 rounded-b-xl flex justify-end">
                <button onclick="copyNodeContent()" class="text-blue-600 text-sm hover:underline"><i class="fa-regular fa-copy"></i> å¤åˆ¶å†…å®¹</button>
            </div>
        </div>
    </div>

    <script>
        // ================= é…ç½® =================
        const DEFAULT_SYSTEM_PROMPT = "ä½ æ˜¯ä¸€ä¸ªæ™ºèƒ½åŠ©æ‰‹ã€‚å›ç­”è¦ä¸“ä¸šã€æ¸…æ™°ï¼Œä½¿ç”¨Markdownæ ¼å¼ã€‚";
        const ESA_AI_ENDPOINT = '/api/ai'; // ä½¿ç”¨ /api/ai

        // ================= çŠ¶æ€ =================
        let nodeMap = {}; 
        let rootId = null;
        let activeNodeId = null; 
        let currentChatId = Date.now().toString();
        let branchParentId = null; 
        let chatHistory = JSON.parse(localStorage.getItem('esa_mindforest_history') || '[]');
        let currentFileContent = null;
        let currentFileName = null;
        let currentSystemPrompt = DEFAULT_SYSTEM_PROMPT;
        let autoGreetingEnabled = true;

        // ================= åˆå§‹åŒ– =================
        document.addEventListener('DOMContentLoaded', () => {
            loadSidebar();
            
            if (chatHistory.length > 0) {
                loadChat(chatHistory[0].id);
            } else {
                createNewChat();
            }

            document.getElementById('user-input').addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault(); 
                    sendMessage();
                }
            });

            window.addEventListener('resize', () => { if(cy) cy.resize(); });
        });

        // ================= æ ¸å¿ƒï¼šå…¬å¼æ¸²æŸ“å¼•æ“ =================
        function renderContent(text) {
            if (!text) return "";
            
            const mathMap = {};
            let mathIndex = 0;
            const generateToken = () => `MathToken${Date.now()}_${mathIndex++}_EndToken`;

            const replaceAndStore = (str, regex, wrapperStart = '', wrapperEnd = '') => {
                return str.replace(regex, (match, p1) => {
                    let content = p1 || match;
                    content = content.replace(/\$/g, '');
                    const token = generateToken();
                    mathMap[token] = wrapperStart + content + wrapperEnd;
                    return token;
                });
            };

            let safeText = text;
            safeText = replaceAndStore(safeText, /\\boxed\{[^{}]*(?:\{[^{}]*\}[^{}]*)*\}/g);
            safeText = replaceAndStore(safeText, /\$\$([\s\S]*?)\$\$/g, '$$', '$$');
            safeText = replaceAndStore(safeText, /\\\[([\s\S]*?)\\\]/g, '$$', '$$');
            safeText = replaceAndStore(safeText, /(\\begin\{[a-z]+\*?\}[\s\S]*?\\end\{[a-z]+\*?\})/g, '$$', '$$');
            safeText = replaceAndStore(safeText, /\\\(([\s\S]*?)\\\)/g, '\\(', '\\)');
            safeText = replaceAndStore(safeText, /(?<!\\)\$([^$\n]+?)(?<!\\)\$/g, '\\(', '\\)');

            let html = marked.parse(safeText);
            Object.keys(mathMap).forEach(token => {
                html = html.replace(token, mathMap[token]);
            });

            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = html;
            
            renderMathInElement(tempDiv, {
                delimiters: [
                    {left: '$$', right: '$$', display: true},
                    {left: '\\(', right: '\\)', display: false},
                    {left: '\\begin{equation}', right: '\\end{equation}', display: true},
                    {left: '\\begin{align}', right: '\\end{align}', display: true},
                    {left: '\\begin{alignat}', right: '\\end{alignat}', display: true},
                    {left: '\\begin{gather}', right: '\\end{gather}', display: true},
                    {left: '\\begin{CD}', right: '\\end{CD}', display: true},
                    {left: '\\[', right: '\\]', display: true}
                ],
                throwOnError: false,
                output: 'html', 
                strict: false,
                trust: true
            });

            return tempDiv.innerHTML;
        }

        // ================= èŠ‚ç‚¹ç®¡ç† =================
        function createNode(role, content, parentId = null, systemPromptSnapshot = null) {
            const id = Date.now().toString(36) + Math.random().toString(36).substr(2);
            const node = { 
                id, parentId, role, content, 
                children: [], 
                timestamp: Date.now(),
                systemPrompt: systemPromptSnapshot || currentSystemPrompt
            };
            nodeMap[id] = node;
            if (parentId && nodeMap[parentId]) nodeMap[parentId].children.push(id);
            else rootId = id;
            
            return node;
        }

        // ================= è§†å›¾é€»è¾‘ =================
        function renderStreamView() {
            const container = document.getElementById('chat-container');
            container.innerHTML = ''; 
            if (!activeNodeId) return;

            const path = getLineage(activeNodeId);
            const lastNode = path[path.length - 1];
            if (lastNode && lastNode.systemPrompt) currentSystemPrompt = lastNode.systemPrompt;

            path.forEach(node => {
                const isUser = node.role === 'user';
                
                let branchNav = '';
                if (node.parentId) {
                    const parent = nodeMap[node.parentId];
                    if (parent && parent.children.length > 1) {
                        const idx = parent.children.indexOf(node.id);
                        branchNav = `
                            <div class="flex items-center gap-2 text-xs text-gray-400 mb-1 select-none">
                                <button onclick="switchSibling('${parent.id}', -1, '${node.id}')" class="hover:text-blue-600 p-1"><i class="fa-solid fa-chevron-left"></i></button>
                                <span>åˆ†æ”¯ ${idx + 1}/${parent.children.length}</span>
                                <button onclick="switchSibling('${parent.id}', 1, '${node.id}')" class="hover:text-blue-600 p-1"><i class="fa-solid fa-chevron-right"></i></button>
                            </div>`;
                    }
                }

                const div = document.createElement('div');
                div.className = `flex flex-col ${isUser ? 'items-end' : 'items-start'} animate-slide-up`;
                
                const renderedHtml = renderContent(node.content);
                
                div.innerHTML = `
                    <div class="flex flex-col ${isUser ? 'items-end' : 'items-start'} max-w-[90%] lg:max-w-[80%] group relative mt-4">
                        ${branchNav}
                        <div class="relative px-5 py-3 rounded-2xl shadow-sm text-sm leading-relaxed ${isUser ? 'bg-blue-600 text-white rounded-tr-none' : 'bg-white border border-gray-100 text-gray-800 rounded-tl-none'}">
                            <div class="prose prose-sm max-w-none ${isUser?'text-white':''}">${renderedHtml}</div>
                            <div class="absolute -bottom-6 ${isUser ? 'right-0' : 'left-0'} opacity-0 group-hover:opacity-100 transition-opacity flex gap-2">
                                <button onclick="setBranchPoint('${node.id}')" class="text-xs text-gray-400 hover:text-blue-600 flex items-center gap-1 bg-white/80 px-2 py-1 rounded shadow-sm border">
                                    <i class="fa-solid fa-code-branch"></i> åœ¨æ­¤åˆ†å‰
                                </button>
                            </div>
                        </div>
                    </div>`;
                container.appendChild(div);
            });
            container.scrollTop = container.scrollHeight;
        }

        function getLineage(endNodeId) {
            const path = [];
            let curr = endNodeId;
            while (curr && nodeMap[curr]) {
                path.unshift(nodeMap[curr]);
                curr = nodeMap[curr].parentId;
            }
            return path;
        }
        
        function switchSibling(parentId, direction, currentNodeId) {
            const parent = nodeMap[parentId];
            const idx = parent.children.indexOf(currentNodeId);
            const nextIdx = idx + direction;
            if (nextIdx >= 0 && nextIdx < parent.children.length) {
                activeNodeId = findDeepestLatestDescendant(parent.children[nextIdx]);
                renderStreamView();
                saveCurrentChat();
            }
        }
        
        function findDeepestLatestDescendant(nodeId) {
            let curr = nodeMap[nodeId];
            while(curr.children && curr.children.length > 0) {
                curr = nodeMap[curr.children[curr.children.length - 1]];
            }
            return curr.id;
        }
        
        function setBranchPoint(nodeId) {
            branchParentId = nodeId;
            document.getElementById('branch-indicator').classList.remove('hidden');
            document.getElementById('user-input').focus();
        }
        
        function cancelBranching() {
            branchParentId = null;
            document.getElementById('branch-indicator').classList.add('hidden');
        }

        // ================= å‘é€æ¶ˆæ¯ =================
        async function sendMessage() {
            const inputEl = document.getElementById('user-input');
            let content = inputEl.value.trim();
            if (!content && !currentFileContent) return;
            inputEl.value = ''; inputEl.style.height = 'auto';

            let displayContent = content; 
            let finalPrompt = content;

            if (currentFileContent) {
                finalPrompt = `ã€æ–‡æ¡£å†…å®¹ã€‘\n${currentFileContent}\n\nã€ç”¨æˆ·æŒ‡ä»¤ã€‘\n${content || "è¯·åˆ†ææ–‡æ¡£"}`;
                displayContent = `ğŸ“‚ [Word] ${currentFileName}\n${content}`;
                clearFile();
            }

            let parentId = branchParentId || activeNodeId;
            let userNode;

            if (!rootId && !parentId) {
                userNode = createNode('user', displayContent, null); 
                activeNodeId = userNode.id;
            } else {
                userNode = createNode('user', displayContent, parentId);
                parentId = userNode.id;
                activeNodeId = userNode.id;
            }
            
            cancelBranching();
            renderStreamView();
            saveCurrentChat();

            const historyNodes = getLineage(parentId);
            const messages = historyNodes.map(n => ({
                role: n.role,
                content: n.id === userNode.id ? finalPrompt : n.content 
            }));
            messages.unshift({ role: "system", content: currentSystemPrompt });

            const container = document.getElementById('chat-container');
            const loadingDiv = document.createElement('div');
            loadingDiv.className = "flex flex-col items-start animate-slide-up mt-4";
            loadingDiv.innerHTML = `<div class="bg-white border border-gray-100 px-5 py-3 rounded-2xl rounded-tl-none shadow-sm"><div class="flex gap-1 h-5 items-center"><div class="typing-dot w-2 h-2 bg-gray-400 rounded-full"></div><div class="typing-dot w-2 h-2 bg-gray-400 rounded-full"></div></div></div>`;
            container.appendChild(loadingDiv);
            container.scrollTop = container.scrollHeight;

            try {
                const aiNode = createNode('assistant', '', parentId);
                activeNodeId = aiNode.id;

                // è°ƒç”¨AI API - ä½¿ç”¨éæµå¼ç®€åŒ–ç‰ˆæœ¬
                const response = await fetch(ESA_AI_ENDPOINT, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        model: "deepseek-v3", 
                        messages: messages
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`API Error: ${response.status} - ${errorText}`);
                }
                
                const data = await response.json();
                
                loadingDiv.remove();
                renderStreamView(); 
                
                // æ›´æ–°AIèŠ‚ç‚¹å†…å®¹
                if (data.choices && data.choices[0] && data.choices[0].message) {
                    aiNode.content = data.choices[0].message.content;
                } else {
                    throw new Error('APIè¿”å›æ ¼å¼é”™è¯¯');
                }
                
                // é‡æ–°æ¸²æŸ“æ˜¾ç¤ºAIå›å¤
                renderStreamView();
                saveCurrentChat();
            } catch (error) {
                console.error('å‘é€æ¶ˆæ¯å¤±è´¥:', error);
                loadingDiv.innerHTML = `<div class="text-red-500 px-4 py-2 bg-red-50 rounded border border-red-200">
                    <div class="font-semibold">è¯·æ±‚å¤±è´¥</div>
                    <div class="text-sm">${error.message}</div>
                </div>`;
            }
        }

        // ================= æ ‘çŠ¶å›¾ (Cytoscape) =================
        let cy = null;

        function toggleView() {
            const streamView = document.getElementById('stream-view');
            const treeView = document.getElementById('tree-view');
            const btnText = document.getElementById('view-toggle-text');

            if (streamView.style.opacity === '0') {
                streamView.style.opacity = '1';
                streamView.style.pointerEvents = 'auto';
                treeView.style.opacity = '0';
                treeView.style.pointerEvents = 'none';
                btnText.innerText = "åˆ‡æ¢æ€ç»´æ ‘è§†å›¾";
            } else {
                streamView.style.opacity = '0';
                streamView.style.pointerEvents = 'none';
                treeView.style.opacity = '1';
                treeView.style.pointerEvents = 'auto';
                btnText.innerText = "è¿”å›å¯¹è¯è§†å›¾";
                setTimeout(() => { initTree(); if (cy) { cy.resize(); cy.fit(); } }, 50);
            }
        }

        function initTree() {
            if (!rootId) return;
            if (cy) cy.destroy();

            const elements = [];
            Object.values(nodeMap).forEach(node => {
                const label = node.role === 'user' ? 'ğŸ‘¤ ' + node.content.substring(0, 10) : 'ğŸ¤– ' + node.content.substring(0, 10);
                const safeLabel = label.replace(/\n/g, ' ');
                elements.push({
                    data: { 
                        id: node.id, 
                        label: safeLabel + (node.content.length > 10 ? '...' : ''),
                        fullContent: node.content,
                        role: node.role
                    }
                });
                if (node.parentId) elements.push({ data: { source: node.parentId, target: node.id } });
            });

            cy = cytoscape({
                container: document.getElementById('cy'),
                elements: elements,
                wheelSensitivity: 0.05, 
                minZoom: 0.4,
                maxZoom: 1.5,
                style: [
                    {
                        selector: 'node',
                        style: {
                            'background-color': ele => ele.data('role') === 'user' ? '#2563eb' : '#ffffff',
                            'label': 'data(label)',
                            'color': ele => ele.data('role') === 'user' ? '#fff' : '#334155',
                            'text-valign': 'center', 'text-halign': 'center',
                            'width': 'label', 'height': 36, 'padding': '12px',
                            'shape': 'round-rectangle',
                            'border-width': 1, 'border-color': '#94a3b8', 'font-size': '12px'
                        }
                    },
                    {
                        selector: 'edge',
                        style: { 'width': 2, 'line-color': '#cbd5e1', 'target-arrow-color': '#cbd5e1', 'target-arrow-shape': 'triangle', 'curve-style': 'bezier' }
                    },
                    {
                        selector: `#${activeNodeId}`,
                        style: { 'border-color': '#10b981', 'border-width': 3, 'background-color': '#d1fae5', 'color': '#065f46' }
                    }
                ],
                layout: { name: 'breadthfirst', directed: true, padding: 50, spacingFactor: 1.2 }
            });

            cy.on('tap', 'node', function(evt){
                activeNodeId = evt.target.id();
                renderStreamView(); 
                toggleView(); 
                setTimeout(() => {
                    const allBubbles = document.getElementById('chat-container').querySelectorAll('.group');
                    if (allBubbles.length > 0) allBubbles[allBubbles.length - 1].scrollIntoView({ behavior: 'smooth', block: 'center' });
                }, 100);
            });

            cy.on('cxttap', 'node', function(evt){
                showNodeDetail(evt.target.data());
            });
            
            cy.ready(() => cy.fit());
        }

        // ================= å¼¹çª—é€»è¾‘ =================
        function showNodeDetail(nodeData) {
            const modal = document.getElementById('node-detail-modal');
            const contentDiv = document.getElementById('node-detail-content');
            const iconSpan = document.getElementById('detail-role-icon');
            
            if (nodeData.role === 'user') iconSpan.innerHTML = '<i class="fa-solid fa-user text-blue-600"></i>';
            else iconSpan.innerHTML = '<i class="fa-solid fa-robot text-purple-600"></i>';

            contentDiv.innerHTML = renderContent(nodeData.fullContent);
            modal.classList.remove('hidden');
        }

        function closeNodeDetail() {
            document.getElementById('node-detail-modal').classList.add('hidden');
        }

        function copyNodeContent() {
            const content = document.getElementById('node-detail-content').innerText;
            navigator.clipboard.writeText(content).then(() => alert('å·²å¤åˆ¶'));
        }

        function toggleSystemPromptConfig() {
            const modal = document.getElementById('system-prompt-modal');
            const input = document.getElementById('system-prompt-input');
            if (modal.classList.contains('hidden')) {
                input.value = currentSystemPrompt;
                modal.classList.remove('hidden');
            } else {
                modal.classList.add('hidden');
            }
        }
        
        function saveSystemPrompt() {
            const val = document.getElementById('system-prompt-input').value.trim();
            if (val) {
                currentSystemPrompt = val;
            }
            toggleSystemPromptConfig();
        }

        // ================= å¯¹è¯ç®¡ç† =================
        function saveCurrentChat() {
            if (!currentChatId) return;
            
            const chatData = { 
                rootId, 
                activeNodeId, 
                nodeMap,
                systemPrompt: currentSystemPrompt
            };
            
            localStorage.setItem(`esa_chat_${currentChatId}`, JSON.stringify(chatData));
            const rootNode = nodeMap[rootId];
            const title = rootNode ? rootNode.content.substring(0, 10) + "..." : "æ–°å¯¹è¯";
            const existingIndex = chatHistory.findIndex(c => c.id === currentChatId);
            if (existingIndex >= 0) {
                chatHistory[existingIndex].title = title;
                chatHistory[existingIndex].timestamp = Date.now();
            } else {
                chatHistory.unshift({ id: currentChatId, title, timestamp: Date.now() });
            }
            localStorage.setItem('esa_mindforest_history', JSON.stringify(chatHistory));
            loadSidebar();
            document.getElementById('current-chat-title').innerText = title;
        }
        
        async function handleFileUpload(input) {
            const file = input.files[0];
            if (!file) return;
            if (!file.name.endsWith('.docx')) { alert('ä»…æ”¯æŒ .docx'); return; }
            const preview = document.getElementById('file-preview');
            preview.classList.remove('hidden');
            document.getElementById('file-name').innerText = file.name;
            try {
                const arrayBuffer = await file.arrayBuffer();
                const result = await mammoth.extractRawText({ arrayBuffer: arrayBuffer });
                currentFileContent = result.value;
            } catch (e) { alert("è§£æå¤±è´¥"); }
        }
        
        function clearFile() {
            document.getElementById('file-upload').value = '';
            document.getElementById('file-preview').classList.add('hidden');
            currentFileContent = null;
        }
        
        function loadSidebar() {
            const listEl = document.getElementById('history-list');
            listEl.innerHTML = '';
            chatHistory.forEach(chat => {
                const item = document.createElement('div');
                item.className = `p-3 rounded cursor-pointer transition-colors flex justify-between group text-sm mb-1 ${chat.id === currentChatId ? 'bg-slate-800' : 'hover:bg-slate-800'}`;
                item.innerHTML = `<div class="truncate flex-1" onclick="loadChat('${chat.id}')">${chat.title}</div><button onclick="deleteChat('${chat.id}', event)" class="opacity-0 group-hover:opacity-100 text-slate-500 hover:text-red-400 ml-2"><i class="fa-solid fa-trash"></i></button>`;
                listEl.appendChild(item);
            });
        }
        
        function createNewChat() {
            currentChatId = Date.now().toString();
            nodeMap = {}; rootId = null; activeNodeId = null; branchParentId = null;
            currentSystemPrompt = DEFAULT_SYSTEM_PROMPT;
            autoGreetingEnabled = true;
            
            document.getElementById('chat-container').innerHTML = `<div class="text-center text-gray-400 mt-20"><i class="fa-solid fa-seedling text-4xl mb-4 text-green-300"></i><br>å¼€å§‹ä¸€é¢—æ–°çš„æ€ç»´æ ‘</div>`;
            document.getElementById('current-chat-title').innerText = "æ–°å¯¹è¯";
            
            if (document.getElementById('stream-view').style.opacity === '0') toggleView();
            loadSidebar();
            
            // è‡ªåŠ¨å‘é€"ä½ å¥½"
            setTimeout(() => {
                if (autoGreetingEnabled) {
                    document.getElementById('user-input').value = 'ä½ å¥½';
                    sendMessage();
                }
            }, 500);
        }
        
        function loadChat(chatId) {
            const dataStr = localStorage.getItem(`esa_chat_${chatId}`);
            if (!dataStr) return;
            const data = JSON.parse(dataStr);
            currentChatId = chatId; 
            nodeMap = data.nodeMap; 
            rootId = data.rootId; 
            activeNodeId = data.activeNodeId;
            currentSystemPrompt = data.systemPrompt || DEFAULT_SYSTEM_PROMPT;
            autoGreetingEnabled = false;
            
            const hist = chatHistory.find(c => c.id === chatId);
            if(hist) document.getElementById('current-chat-title').innerText = hist.title;
            
            renderStreamView(); 
            loadSidebar();
            if (document.getElementById('stream-view').style.opacity === '0') initTree();
        }
        
        function deleteChat(chatId, event) {
            event.stopPropagation();
            if(!confirm("åˆ é™¤?")) return;
            localStorage.removeItem(`esa_chat_${chatId}`);
            chatHistory = chatHistory.filter(c => c.id !== chatId);
            localStorage.setItem('esa_mindforest_history', JSON.stringify(chatHistory));
            if (currentChatId === chatId) createNewChat(); else loadSidebar();
        }
    </script>
</body>
</html>
